<link rel="import" href="/bower_components/core-ajax/core-ajax.html">

<polymer-element name="paste-service" attributes="lastid pastes paste query error noauto">
  <template>
    <style>
      :host {
        display: none;
      }
    </style>
    <core-ajax id="ajax" auto="{{!noauto}}" url="/api/{{query}}" response="{{response}}" handleAs="json"></core-ajax>
  </template>
  <script>
    Polymer({
      created: function() {
        this.pastes = [];
        this.paste = '';
        this.lastid = '';
        this.error = false;
        if (!this.query) {
          this.query = 'posts/' + Math.floor((new Date()).getTime() / 1000);
        }
      },
      responseChanged: function(oldValue) {
        if (this.response && !this.response.error) {
          if (typeof this.response.length !== 'undefined') {
            if (this.response.length != 10) { this.error = true };
            this.lastid = this.response[this.response.length - 1].timestamp;
            this.pastes = this.pastes.concat(this.response);
          } else {
            if (typeof this.response.url !== 'undefined') {
              document.location.href = this.response.url;
            } else {
              this.paste = this.response;
            }
          }
        } else {
          this.error = true;
        }
      },
      addPaste: function(age, content) {
        this.query = 'post';
        var ajax = this.$.ajax;
        ajax.method = 'POST';
        ajax.contentType = 'application/json';
        ajax.body = JSON.stringify({ age: age, content: content });
        ajax.go();
      },
    });
  </script>
</polymer-element>
